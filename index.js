(function(){"use strict";var k=function(){var e=this,a=e.$createElement,t=e._self._c||a;return t("div",{staticClass:"embedded-maps"},[t("div",{staticClass:"embedded-map-item",attrs:{id:e.mapId},on:{update:e.update}})])},b=[],q="";function f(e,a,t,r,o,i,c,u){var n=typeof e=="function"?e.options:e;a&&(n.render=a,n.staticRenderFns=t,n._compiled=!0),r&&(n.functional=!0),i&&(n._scopeId="data-v-"+i);var s;if(c?(s=function(l){l=l||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext,!l&&typeof __VUE_SSR_CONTEXT__!="undefined"&&(l=__VUE_SSR_CONTEXT__),o&&o.call(this,l),l&&l._registeredComponents&&l._registeredComponents.add(c)},n._ssrRegister=s):o&&(s=u?function(){o.call(this,(n.functional?this.parent:this).$root.$options.shadowRoot)}:o),s)if(n.functional){n._injectStyles=s;var h=n.render;n.render=function(m,d){return s.call(d),h(m,d)}}else{var p=n.beforeCreate;n.beforeCreate=p?[].concat(p,s):[s]}return{exports:e,options:n}}const y={data(){return{map:null,attachedMarker:[],attachedPopup:[],options:null}},computed:{mapId(){return`map-${this._uid}`},center(){if(!this.content.center)return[0,20];const e=this.field("marker").fieldsets.marker.tabs.content.fields.coordinates,{name:a,lat:t,lng:r}=this.content.center;return e.defaultName=a,e.defaultLat=t,e.defaultLng=r,[r,t]},marker(){return this.content.marker.map(({content:e})=>{var t,r,o,i,c,u,n,s,h,p,l,m,d,$;const a=(i=(o=(r=(t=e.image)==null?void 0:t[0])==null?void 0:r.info)==null?void 0:o.split(" \xD7 "))!=null?i:[0,0];return{image:(u=(c=e.image)==null?void 0:c[0])==null?void 0:u.url,width:a[0]/100*e.size,height:a[1]/100*e.size,lat:(p=(h=(n=e.coordinates)==null?void 0:n.lat)!=null?h:(s=e.coors)==null?void 0:s.lat)!=null?p:0,lng:($=(d=(l=e.coordinates)==null?void 0:l.lng)!=null?d:(m=e.coors)==null?void 0:m.lng)!=null?$:51,anchor:e.anchor,hasPopup:e.haspopup,popup:e.popup,popupOffset:e.popupoffset}})}},watch:{"content.style":function(e){this.map&&this.map.setStyle(`mapbox://styles/mapbox/${e}`)},"content.zoom":function(e){this.map&&this.map.setZoom(e)},center(e){this.map&&this.map.setCenter(e)},marker(e){this.attachedPopup.forEach(a=>a.remove()),this.attachedPopup=[],this.attachedMarker.forEach(a=>a.remove()),this.attachedMarker=[],this.setMarker(e)}},created(){const e="https://api.mapbox.com/mapbox-gl-js/v2.3.1";let a;const t="mapbox-gl.css";document.getElementById(t)||(a=document.createElement("link"),a.id=t,a.href=`${e}/${t}`,a.rel="stylesheet",document.head.appendChild(a));const r="mapbox-gl.js";document.getElementById(r)?this.initMap():(a=document.createElement("script"),a.id=r,a.addEventListener("load",this.initMap),a.src=`${e}/${r}`,document.body.appendChild(a))},methods:{async initMap(){var a,t;const e=await this.$api.get("map/options");this.options=e,mapboxgl.accessToken=this.options.token,this.map=new mapboxgl.Map({container:this.mapId,center:this.center,style:`mapbox://styles/mapbox/${(a=this.content.style)!=null?a:this.options.defaultStyle}`,zoom:(t=this.content.zoom)!=null?t:1}),this.map.scrollZoom.disable(),this.setMarker(this.marker)},async setMarker(e){var a;if(!!e)for(const t of e){let r=null;t.image&&(r=document.createElement("div"),r.className="marker",r.style.backgroundImage=`url(${t.image})`,r.style.width=`${t.width}px`,r.style.height=`${t.height}px`,r.style.backgroundSize="100%");const o=new mapboxgl.Marker({anchor:(a=t.anchor)!=null?a:null,element:r}).setLngLat([t.lng,t.lat]).addTo(this.map);if(this.attachedMarker.push(o),t.hasPopup){const i=new mapboxgl.Popup({offset:parseInt(t.popupOffset),focusAfterOpen:!1});i.setLngLat([t.lng,t.lat]),i.setHTML(t.popup).addTo(this.map),this.attachedPopup.push(i)}}}}},_={};var x=f(y,k,b,!1,M,null,null,null);function M(e){for(let a in _)this[a]=_[a]}var E=function(){return x.exports}(),w=function(){var e=this,a=e.$createElement,t=e._self._c||a;return t("div",{staticClass:"marker-item",on:{click:e.open}},[e.url?t("div",{staticClass:"marker-item-image"},[t("img",{attrs:{src:e.url}})]):e._e(),t("div",{staticClass:"marker-item-description"},[t("p",[e._v(e._s(e.description||e.$t("empty")))]),t("p",[e._v(e._s(e.coordinates))])])])},C=[],D="";const S={computed:{url(){var e,a,t;return(t=(a=(e=this.content.image)==null?void 0:e[0])==null?void 0:a.icon)==null?void 0:t.url},description(){var e,a,t;return(t=(e=this.content.coordinates)==null?void 0:e.name)!=null?t:(a=this.content.coors)==null?void 0:a.name},coordinates(){return this.content.coordinates?`${this.content.coordinates.lat},${this.content.coordinates.lng}`:this.content.coors?"(This marker was created with an older version. Please set the position from scratch.)":null}}},g={};var L=f(S,w,C,!1,z,null,null,null);function z(e){for(let a in g)this[a]=g[a]}var N=function(){return L.exports}(),O=function(){var e=this,a=e.$createElement,t=e._self._c||a;return t("k-field",e._b({staticClass:"k-geolocation-field",attrs:{label:e.label,required:e.required,disabled:e.disabled},scopedSlots:e._u([{key:"options",fn:function(){return[t("k-button",{attrs:{text:e.$t("search"),icon:"search"},on:{click:function(r){return e.openSearch()}}})]},proxy:!0}])},"k-field",e.$props,!1),[t("k-dialog",{ref:"search",attrs:{size:"medium",submitbutton:!1}},[t("k-text-field",{ref:"name",staticClass:"k-geolocation-search",attrs:{type:"text",theme:"field",label:e.$t("map.blocks.marker.location.name"),value:e.search,icon:"search"},on:{input:function(r){return e.searchLocation(r)}}}),t("k-collection",{attrs:{items:e.dropdownOptions,empty:{icon:"alert",text:e.$t(e.searchError,1)}},on:{item:function(r){return e.selectDropdown(r)}}})],1),t("k-input",{ref:"name",attrs:{type:"text",theme:"field",value:e.location.name,before:e.$t("maps.field.geolocation.name")},on:{input:function(r){return e.setValue(r,"name")}}}),t("k-input",{ref:"lat",attrs:{type:"text",theme:"field",value:e.location.lat,before:e.$t("maps.field.geolocation.lat")},on:{input:function(r){return e.setValue(r,"lat")}}}),t("k-input",{ref:"lng",attrs:{type:"text",theme:"field",value:e.location.lng,before:e.$t("maps.field.geolocation.lng")},on:{input:function(r){return e.setValue(r,"lng")}}}),e.error?t("k-box",{attrs:{text:e.error,theme:"negative"}}):e._e()],1)},P=[],V="";const T={props:{token:{type:String,required:!0},label:{type:String,required:!0},value:{type:Object,default(){return{name:void 0,lat:void 0,lng:void 0}}},required:Boolean,disabled:Boolean,default:{type:Object,default(){return{name:"",lat:0,lng:0}}}},data(){return{geoData:[],error:null,searchError:"search.min"}},computed:{mapId(){return`map-${this._uid}`},location(){var e,a,t,r,o,i,c,u,n,s,h,p;return{name:(r=(t=(e=this.value)==null?void 0:e.name)!=null?t:(a=this.default)==null?void 0:a.name)!=null?r:"",lat:(u=(c=(o=this.value)==null?void 0:o.lat)!=null?c:(i=this.default)==null?void 0:i.lat)!=null?u:0,lng:(p=(h=(n=this.value)==null?void 0:n.lng)!=null?h:(s=this.default)==null?void 0:s.lng)!=null?p:0}},dropdownOptions(){return this.geoData.map(({place_name:e,place_type:a,center:t})=>({text:e,name:e,info:this.$t(`maps.field.geolocation.${a[0]}`),lat:t[1],lng:t[0]}))}},methods:{async searchLocation(e){if(e.length===0){this.searchError="maps.search.empty";return}this.geoData=[];try{const t=await(await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${e}.json?types=address,country,postcode,place,locality&limit=5&access_token=${this.token}`)).json();if(this.searchError="maps.field.geolocation.error.empty",t.features){const r=t.features.slice(0,8);r?this.geoData=r:this.searchError="maps.search.error"}else this.searchError=t==null?void 0:t.message}catch{this.searchError="maps.search.error"}},openSearch(){this.geoData=[],this.searchError="maps.search.empty",this.$refs.search.open()},selectDropdown(e){console.log(e),this.$refs.search.close(),delete e.type,delete e.text,this.$refs.search.close(),this.$emit("input",e)},setValue(e,a){let t={name:a==="name"?e:this.location.name,lat:a==="lat"?e:this.location.lat,lng:a==="lng"?e:this.location.lng};if(this.$emit("input",t),this.required&&(!t.name||!t.lat||!t.lng)){this.error=this.$t("maps.field.geolocation.error");return}if(!t.name){this.error=this.$t("maps.field.geolocation.name.error");return}if(!t.lat||isNaN(t.lat)||Math.abs(t.lat)>90){this.error=this.$t("maps.field.geolocation.lat.error");return}if(!t.lng||isNaN(t.lng)||Math.abs(t.lng)>180){this.error=this.$t("maps.field.geolocation.lng.error");return}this.error=null}}},v={};var j=f(T,O,P,!1,I,null,null,null);function I(e){for(let a in v)this[a]=v[a]}var R=function(){return j.exports}();window.panel.plugin("microman/map",{blocks:{marker:N,maps:E},fields:{geolocation:R}})})();
