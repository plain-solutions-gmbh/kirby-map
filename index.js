(function(){"use strict";var b=function(){var t=this,n=t.$createElement,e=t._self._c||n;return e("div",[e("k-box",{staticClass:"maps-bar",attrs:{theme:"text"}},[e("k-button-group",{attrs:{layout:"collapsed"}},[t.fail.length>0?e("k-button",{staticClass:"maps-token-fail",attrs:{variant:"filled",icon:"alert",link:"https://github.com/plain-solutions-gmbh/kirby-map",theme:"negative"}},[t._v(t._s(t.fail))]):t._e(),t.lock?t._e():e("k-button",{attrs:{disabled:!t.newCenter,variant:"filled",icon:"circle-nested"},on:{click:function(r){return t.setNewCenter()}}},[t._v(t._s(t.$t("maps.blocks.button.center")))]),t.lock?t._e():e("k-button",{attrs:{variant:"filled",icon:t.wait?"loader":"pin",disabled:t.wait},on:{click:function(r){return t.addMarker()}}},[t._v(t._s(t.$t("maps.blocks.button.pin")))]),e("k-button",{attrs:{variant:"filled",theme:t.lock?"warning":"green",icon:t.lock?"lock":"unlock"},on:{click:function(r){return t.toggleLock()}}})],1)],1),e("div",{staticClass:"embedded-maps"},[e("div",{staticClass:"embedded-map-item",attrs:{id:t.mapId},on:{update:t.update}})]),e("k-plain-license",{attrs:{prefix:"map"}})],1)},w=[],Q="";function d(t,n,e,r,a,o,i,u){var s=typeof t=="function"?t.options:t;n&&(s.render=n,s.staticRenderFns=e,s._compiled=!0),r&&(s.functional=!0),o&&(s._scopeId="data-v-"+o);var l;if(i?(l=function(c){c=c||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext,!c&&typeof __VUE_SSR_CONTEXT__!="undefined"&&(c=__VUE_SSR_CONTEXT__),a&&a.call(this,c),c&&c._registeredComponents&&c._registeredComponents.add(i)},s._ssrRegister=l):a&&(l=u?function(){a.call(this,(s.functional?this.parent:this).$root.$options.shadowRoot)}:a),l)if(s.functional){s._injectStyles=l;var h=s.render;s.render=function(f,m){return l.call(m),h(f,m)}}else{var p=s.beforeCreate;s.beforeCreate=p?[].concat(p,l):[l]}return{exports:t,options:s}}const x={data(){return{map:null,attachedMarker:[],attachedPopup:[],token:null,fail:"",lock:!0,newCenter:!1,wait:!1}},computed:{mapId(){return`map-${this._uid}`},center(){if(!this.content.center||this.content.center.length<1)return[0,20];const t=this.field("marker").fieldsets.marker.tabs.content.fields.coordinates,{name:n,lat:e,lng:r}=this.content.center;return t.defaultName=n,t.defaultLat=e,t.defaultLng=r,[r,e]},marker(){return this.content.marker.map(({content:t})=>{var e,r,a,o,i,u,s,l,h,p,c,f,m,y;const n=(o=(a=(r=(e=t.image)==null?void 0:e[0])==null?void 0:r.info)==null?void 0:a.split(" \xD7 "))!=null?o:[0,0];return{image:(u=(i=t.image)==null?void 0:i[0])==null?void 0:u.url,width:n[0]/100*t.size,height:n[1]/100*t.size,lat:(p=(h=(s=t.coordinates)==null?void 0:s.lat)!=null?h:(l=t.coors)==null?void 0:l.lat)!=null?p:0,lng:(y=(m=(c=t.coordinates)==null?void 0:c.lng)!=null?m:(f=t.coors)==null?void 0:f.lng)!=null?y:51,anchor:t.anchor,hasPopup:t.haspopup,popup:t.popup,popupOffset:t.popupoffset}})}},watch:{"content.style":function(t){this.map&&this.map.setStyle(`mapbox://styles/mapbox/${t}`)},"content.zoom":function(t){this.map&&this.map.setZoom(t)},center(t){this.map&&this.map.setCenter(t)},marker(t){this.attachedPopup.forEach(n=>n.remove()),this.attachedPopup=[],this.attachedMarker.forEach(n=>n.remove()),this.attachedMarker=[],this.setMarker(t)}},created(){const t="https://api.mapbox.com/mapbox-gl-js/v3.9.4";let n;const e="mapbox-gl.css";document.getElementById(e)||(n=document.createElement("link"),n.id=e,n.href=`${t}/${e}`,n.rel="stylesheet",document.head.appendChild(n));const r="mapbox-gl.js";document.getElementById(r)?this.initMap():(n=document.createElement("script"),n.id=r,n.addEventListener("load",this.initMap),n.src=`${t}/${r}`,document.body.appendChild(n))},methods:{async initMap(){var n,e;const t=this;if((n=this.token)!=null||(this.token=(await this.$api.get("map/options")).token),this.token===null)return this.fail=t.setError("Token missing (Check: https://github.com/plain-solutions-gmbh/kirby-map?tab=readme-ov-file#configuration)");mapboxgl.accessToken=this.token,this.map=new mapboxgl.Map({container:this.mapId,center:this.center,style:"mapbox://styles/mapbox/"+this.content.style,zoom:(e=this.content.zoom)!=null?e:1}),this.map.on("error",function(r){if(r.error==="ee"){t.setError("Fail to fetch mapbox. Check your api token.");return}fetch(r.error.url).then(a=>a.json()).then(a=>{t.setError(a.message)}).catch(a=>{t.setError(a)})}),this.toggleLock(this.content.center.length===0),this.map.on("dragend",()=>{this.newCenter=!0}),this.map.on("zoom",()=>{this.newCenter=!0}),this.setMarker(this.marker)},async setMarker(t){var n;if(!!t)for(const[e,r]of t.entries()){let a=null;r.image&&(a=document.createElement("div"),a.className="marker",a.style.backgroundImage=`url(${r.image})`,a.style.width=`${r.width}px`,a.style.height=`${r.height}px`,a.style.backgroundSize="100%");const o=new mapboxgl.Marker({anchor:(n=r.anchor)!=null?n:null,element:a,draggable:!0}).setLngLat([r.lng,r.lat]).addTo(this.map);if(o.getElement().addEventListener("click",()=>{const i=this;this.$panel.drawer.open({component:"k-form-drawer",props:this.$helper.object.merge(this.field("marker").fieldsets.marker,{value:this.content.marker[e].content}),on:{input(u){i.content.marker[e].content=u,i.$emit("update",this.content)}}})}),o.on("dragend",()=>{const i=o.getLngLat().wrap();this.content.marker[e].content.coordinates.lat=i.lat,this.content.marker[e].content.coordinates.lng=i.lng,this.$emit("update",this.content)}),this.attachedMarker.push(o),r.hasPopup){const i=new mapboxgl.Popup({offset:parseInt(r.popupOffset),focusAfterOpen:!1});i.setLngLat([r.lng,r.lat]),i.setHTML(r.popup).addTo(this.map),this.attachedPopup.push(i)}}},setError(t){this.fail=this.$t("maps.error"),console.error("Kirby-Map: "+t)},setNewCenter(){this.content.center=this.map.getCenter().wrap(),this.content.zoom=this.map.getZoom(),this.$emit("update",this.content),this.newCenter=!1},toggleLock(t=null){t!=null||(t=this.lock),(this.lock=!t)?this.map.scrollZoom.disable():this.map.scrollZoom.enable()},async addMarker(){this.wait=!0;const t=await this.$api.get(this.field("marker").endpoints.field+"/fieldsets/marker");this.wait=!1,t.content.coordinates=this.map.getCenter().wrap(),this.content.marker.push(t),this.setMarker(),this.$emit("update",this.content)}}},_={};var C=d(x,b,w,!1,E,null,null,null);function E(t){for(let n in _)this[n]=_[n]}var M=function(){return C.exports}(),S=function(){var t=this,n=t.$createElement,e=t._self._c||n;return e("div",{staticClass:"marker-item",on:{click:t.open}},[t.url?e("div",{staticClass:"marker-item-image"},[e("img",{attrs:{src:t.url}})]):t._e(),e("div",{staticClass:"marker-item-description"},[e("p",[t._v(t._s(t.description||t.$t("empty")))]),e("p",[t._v(t._s(t.coordinates))])])])},L=[],Y="";const j={computed:{url(){var t,n,e;return(e=(n=(t=this.content.image)==null?void 0:t[0])==null?void 0:n.icon)==null?void 0:e.url},description(){var t,n,e;return(e=(t=this.content.coordinates)==null?void 0:t.name)!=null?e:(n=this.content.coors)==null?void 0:n.name},coordinates(){return this.content.coordinates?`${this.content.coordinates.lat},${this.content.coordinates.lng}`:this.content.coors?"(This marker was created with an older version. Please set the position from scratch.)":null}}},g={};var z=d(j,S,L,!1,T,null,null,null);function T(t){for(let n in g)this[n]=g[n]}var N=function(){return z.exports}(),P=function(){var t=this,n=t.$createElement,e=t._self._c||n;return e("k-field",t._b({staticClass:"k-geolocation-field",attrs:{label:t.label,required:t.required,disabled:t.disabled},scopedSlots:t._u([{key:"options",fn:function(){return[e("k-button",{attrs:{text:t.$t("search"),icon:"search"},on:{click:function(r){return t.openSearch()}}})]},proxy:!0}])},"k-field",t.$props,!1),[e("k-input",{attrs:{type:"text",theme:"field",value:t.location.name,before:t.$t("maps.field.geolocation.name")},on:{input:function(r){return t.setValue(r,"name")}}}),e("k-input",{attrs:{type:"text",theme:"field",value:t.location.lat,before:t.$t("maps.field.geolocation.lat")},on:{input:function(r){return t.setValue(r,"lat")}}}),e("k-input",{attrs:{type:"text",theme:"field",value:t.location.lng,before:t.$t("maps.field.geolocation.lng")},on:{input:function(r){return t.setValue(r,"lng")}}}),t.error?e("k-box",{attrs:{text:t.error,theme:"negative"}}):t._e()],1)},D=[];const R={props:{token:{type:String,required:!0},label:{type:String,required:!0},value:{type:Object,default(){return{name:void 0,lat:void 0,lng:void 0}}},required:Boolean,disabled:Boolean,default:{type:Object,default(){return{name:"",lat:0,lng:0}}}},data(){return{error:null,searchError:"search.min"}},computed:{mapId(){return`map-${this._uid}`},location(){var t,n,e,r,a,o,i,u,s,l,h,p;return{name:(r=(e=(t=this.value)==null?void 0:t.name)!=null?e:(n=this.default)==null?void 0:n.name)!=null?r:"",lat:(u=(i=(a=this.value)==null?void 0:a.lat)!=null?i:(o=this.default)==null?void 0:o.lat)!=null?u:0,lng:(p=(h=(s=this.value)==null?void 0:s.lng)!=null?h:(l=this.default)==null?void 0:l.lng)!=null?p:0}}},methods:{openSearch(){this.searchError="maps.search.empty";const t=this;this.$panel.dialog.open({component:"geolocationSearchDialog",props:{token:this.token},on:{input(n){t.$emit("input",n),t.$panel.dialog.close()}}})},setValue(t,n){let e={name:n==="name"?t:this.location.name,lat:n==="lat"?t:this.location.lat,lng:n==="lng"?t:this.location.lng};if(this.$emit("input",e),this.required&&(!e.name||!e.lat||!e.lng)){this.error=this.$t("maps.field.geolocation.error");return}if(!e.name){this.error=this.$t("maps.field.geolocation.name.error");return}if(!e.lat||isNaN(e.lat)||Math.abs(e.lat)>90){this.error=this.$t("maps.field.geolocation.lat.error");return}if(!e.lng||isNaN(e.lng)||Math.abs(e.lng)>180){this.error=this.$t("maps.field.geolocation.lng.error");return}this.error=null}}},k={};var q=d(R,P,D,!1,I,null,null,null);function I(t){for(let n in k)this[n]=k[n]}var O=function(){return q.exports}(),F=function(){var t=this,n=t.$createElement,e=t._self._c||n;return e("k-dialog",t._b({staticClass:"k-dialog",attrs:{"submit-button":!1,size:"medium"},on:{cancel:function(r){return t.$emit("cancel")},submit:function(r){return t.send()}}},"k-dialog",t.$props,!1),[e("k-text-field",{staticClass:"k-geolocation-search",attrs:{type:"text",theme:"field",label:t.$t("map.blocks.marker.location.name"),icon:"search",value:t.query},on:{input:function(r){return t.searchLocation(r)}}}),e("k-collection",{attrs:{items:t.geoData,empty:{icon:"alert",text:t.$t(t.searchError,1)}},on:{item:function(r){return t.selectDropdown(r)}}})],1)},V=[],tt="";const B={extends:"k-dialog",props:{token:{type:String,required:!0}},data(){return{geoData:[],query:"",error:null,searchError:"search.min"}},methods:{async searchLocation(t){if(!this.token){this.searchError="maps.error.token";return}if(t.length===0){this.searchError="maps.search.empty";return}try{const e=await(await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${t}.json?types=address,country,postcode,place,locality&limit=5&access_token=${this.token}`)).json();if(this.searchError="maps.field.geolocation.error.empty",e.features){const r=e.features.slice(0,8);r?this.geoData=r.map(({place_name:a,place_type:o,center:i})=>({text:a,name:a,info:this.$t(`maps.field.geolocation.${o[0]}`),lat:i[1],lng:i[0]})):this.searchError="maps.search.error"}else this.searchError=e==null?void 0:e.message}catch{this.searchError="maps.search.error"}this.query=t},selectDropdown(t){delete t.type,delete t.text,this.$emit("input",t)}}},v={};var Z=d(B,F,V,!1,U,null,null,null);function U(t){for(let n in v)this[n]=v[n]}var X=function(){return Z.exports}(),A=function(){var t=this,n=t.$createElement,e=t._self._c||n;return t.license!==null?e("div",{staticClass:"k-plain-license",style:t.containerStyle,on:{click:t.showDialog}},[e("k-text",{style:t.textStyle,attrs:{size:"tiny",html:t.licenseText}}),e("k-icon",{style:t.iconStyle,attrs:{type:"alert"}})],1):t._e()},G=[],et="";const H={props:{prefix:{type:String,default(){return null}},styling:{type:Object,default(){return{}}}},data(){return{license:null}},computed:{licenseText(){return this.license?`<strong>${this.license.title}</strong><br />${this.license.cta}`:""},containerStyle(){return this.styling&&this.styling.container?this.styling.container:this.styling},textStyle(){var t,n;return(n=(t=this.styling)==null?void 0:t.text)!=null?n:{}},iconStyle(){var t,n;return(n=(t=this.styling)==null?void 0:t.icon)!=null?n:{}}},created(){this.license=window.panel.translation.data&&window.panel.translation.data["plain.licenses."+this.prefix]?window.panel.translation.data["plain.licenses."+this.prefix]:null,window.panel.translation.data["plain.licenses."+this.prefix]=null},methods:{showDialog(){this.license&&this.license.dialog&&this.$dialog(this.license.dialog)}}},$={};var K=d(H,A,G,!1,W,null,null,null);function W(t){for(let n in $)this[n]=$[n]}var J=function(){return K.exports}();window.panel.plugin("plain/map",{blocks:{marker:N,maps:M},fields:{geolocation:O},components:{geolocationSearchDialog:X,"k-plain-license":J}})})();
