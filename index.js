(function(){"use strict";function l(n,t,e,a,o,r,s,c){var i=typeof n=="function"?n.options:n;return t&&(i.render=t,i.staticRenderFns=e,i._compiled=!0),{exports:n,options:i}}const m={data(){return{map:null,attachedMarker:[],attachedPopup:[],options:null,fail:"",lock:!0,newCenter:!1,wait:!1}},computed:{mapId(){return`map-${this._uid}`},center(){if(!this.content.center||this.content.center.length<1)return[0,20];const n=this.field("marker").fieldsets.marker.tabs.content.fields.coordinates,{name:t,lat:e,lng:a}=this.content.center;return n.defaultName=t,n.defaultLat=e,n.defaultLng=a,[a,e]},marker(){return this.content.marker.map(({content:n})=>{var e,a,o,r,s,c,i,p,h;const t=((o=(a=(e=n.image)==null?void 0:e[0])==null?void 0:a.info)==null?void 0:o.split(" Ã— "))??[0,0];return{image:(s=(r=n.image)==null?void 0:r[0])==null?void 0:s.url,width:t[0]/100*n.size,height:t[1]/100*n.size,lat:((c=n.coordinates)==null?void 0:c.lat)??((i=n.coors)==null?void 0:i.lat)??0,lng:((p=n.coordinates)==null?void 0:p.lng)??((h=n.coors)==null?void 0:h.lng)??51,anchor:n.anchor,hasPopup:n.haspopup,popup:n.popup,popupOffset:n.popupoffset}})}},watch:{"content.style":function(n){this.map&&this.map.setStyle(`mapbox://styles/mapbox/${n}`)},"content.zoom":function(n){this.map&&this.map.setZoom(n)},center(n){this.map&&this.map.setCenter(n)},marker(n){this.attachedPopup.forEach(t=>t.remove()),this.attachedPopup=[],this.attachedMarker.forEach(t=>t.remove()),this.attachedMarker=[],this.setMarker(n)}},created(){const n="https://api.mapbox.com/mapbox-gl-js/v3.9.4";let t;const e="mapbox-gl.css";document.getElementById(e)||(t=document.createElement("link"),t.id=e,t.href=`${n}/${e}`,t.rel="stylesheet",document.head.appendChild(t));const a="mapbox-gl.js";document.getElementById(a)?this.initMap():(t=document.createElement("script"),t.id=a,t.addEventListener("load",this.initMap),t.src=`${n}/${a}`,document.body.appendChild(t))},methods:{async initMap(){const n=await this.$api.get("map/options");if(this.options=n,n.token===null)return this.fail=this.$t("maps.error.token");const t=setTimeout(()=>{this.fail=this.$t("maps.error.timeout")},1e3);mapboxgl.accessToken=this.options.token,this.map=new mapboxgl.Map({container:this.mapId,center:this.center,style:`mapbox://styles/mapbox/${this.content.style??this.options.defaultStyle}`,zoom:this.content.zoom??1}),this.toggleLock(this.content.center.length===0),this.map.on("dragend",()=>{this.newCenter=!0}),this.map.on("zoom",()=>{this.newCenter=!0}),this.setMarker(this.marker),clearTimeout(t)},async setMarker(n){if(n)for(const[t,e]of n.entries()){let a=null;e.image&&(a=document.createElement("div"),a.className="marker",a.style.backgroundImage=`url(${e.image})`,a.style.width=`${e.width}px`,a.style.height=`${e.height}px`,a.style.backgroundSize="100%");const o=new mapboxgl.Marker({anchor:e.anchor??null,element:a,draggable:!0}).setLngLat([e.lng,e.lat]).addTo(this.map);if(o.getElement().addEventListener("click",()=>{const r=this;this.$panel.drawer.open({component:"k-form-drawer",props:this.$helper.object.merge(this.field("marker").fieldsets.marker,{value:this.content.marker[t].content}),on:{input(s){r.content.marker[t].content=s,r.$emit("update",this.content)}}})}),o.on("dragend",()=>{const r=o.getLngLat().wrap();this.content.marker[t].content.coordinates.lat=r.lat,this.content.marker[t].content.coordinates.lng=r.lng,this.$emit("update",this.content)}),this.attachedMarker.push(o),e.hasPopup){const r=new mapboxgl.Popup({offset:parseInt(e.popupOffset),focusAfterOpen:!1});r.setLngLat([e.lng,e.lat]),r.setHTML(e.popup).addTo(this.map),this.attachedPopup.push(r)}}},setNewCenter(){this.content.center=this.map.getCenter().wrap(),this.content.zoom=this.map.getZoom(),this.$emit("update",this.content),this.newCenter=!1},toggleLock(n=null){n??(n=this.lock),(this.lock=!n)?this.map.scrollZoom.disable():this.map.scrollZoom.enable()},async addMarker(){this.wait=!0;const n=await this.$api.get(this.field("marker").endpoints.field+"/fieldsets/marker");this.wait=!1,n.content.coordinates=this.map.getCenter().wrap(),this.content.marker.push(n),this.setMarker(),this.$emit("update",this.content)}}};var d=function(){var t=this,e=t._self._c;return e("div",[e("k-box",{staticClass:"maps-bar",attrs:{theme:"text"}},[e("k-button-group",{attrs:{layout:"collapsed"}},[t.fail.length>0?e("k-button",{staticClass:"maps-token-fail",attrs:{variant:"filled",icon:"alert",link:"https://github.com/plain-solutions-gmbh/kirby-map",theme:"negative"}},[t._v(t._s(t.fail))]):t._e(),t.lock?t._e():e("k-button",{attrs:{disabled:!t.newCenter,variant:"filled",icon:"circle-nested"},on:{click:function(a){return t.setNewCenter()}}},[t._v(t._s(t.$t("maps.blocks.button.center")))]),t.lock?t._e():e("k-button",{attrs:{variant:"filled",icon:t.wait?"loader":"pin",disabled:t.wait},on:{click:function(a){return t.addMarker()}}},[t._v(t._s(t.$t("maps.blocks.button.pin")))]),e("k-button",{attrs:{variant:"filled",theme:t.lock?"warning":"green",icon:t.lock?"lock":"unlock"},on:{click:function(a){return t.toggleLock()}}})],1)],1),e("div",{staticClass:"embedded-maps"},[e("div",{staticClass:"embedded-map-item",attrs:{id:t.mapId},on:{update:t.update}})])],1)},u=[],f=l(m,d,u);const g=f.exports,k={computed:{url(){var n,t,e;return(e=(t=(n=this.content.image)==null?void 0:n[0])==null?void 0:t.icon)==null?void 0:e.url},description(){var n,t;return((n=this.content.coordinates)==null?void 0:n.name)??((t=this.content.coors)==null?void 0:t.name)},coordinates(){return this.content.coordinates?`${this.content.coordinates.lat},${this.content.coordinates.lng}`:this.content.coors?"(This marker was created with an older version. Please set the position from scratch.)":null}}};var _=function(){var t=this,e=t._self._c;return e("div",{staticClass:"marker-item",on:{click:t.open}},[t.url?e("div",{staticClass:"marker-item-image"},[e("img",{attrs:{src:t.url}})]):t._e(),e("div",{staticClass:"marker-item-description"},[e("p",[t._v(t._s(t.description||t.$t("empty")))]),e("p",[t._v(t._s(t.coordinates))])])])},$=[],b=l(k,_,$);const v=b.exports,w={props:{token:{type:String,required:!0},label:{type:String,required:!0},value:{type:Object,default(){return{name:void 0,lat:void 0,lng:void 0}}},required:Boolean,disabled:Boolean,default:{type:Object,default(){return{name:"",lat:0,lng:0}}}},data(){return{error:null,searchError:"search.min"}},computed:{mapId(){return`map-${this._uid}`},location(){var n,t,e,a,o,r;return{name:((n=this.value)==null?void 0:n.name)??((t=this.default)==null?void 0:t.name)??"",lat:((e=this.value)==null?void 0:e.lat)??((a=this.default)==null?void 0:a.lat)??0,lng:((o=this.value)==null?void 0:o.lng)??((r=this.default)==null?void 0:r.lng)??0}}},methods:{openSearch(){this.searchError="maps.search.empty";const n=this;this.$panel.dialog.open({component:"geolocationSearchDialog",props:{token:this.token},on:{input(t){n.$emit("input",t),n.$panel.dialog.close()}}})},setValue(n,t){let e={name:t==="name"?n:this.location.name,lat:t==="lat"?n:this.location.lat,lng:t==="lng"?n:this.location.lng};if(this.$emit("input",e),this.required&&(!e.name||!e.lat||!e.lng)){this.error=this.$t("maps.field.geolocation.error");return}if(!e.name){this.error=this.$t("maps.field.geolocation.name.error");return}if(!e.lat||isNaN(e.lat)||Math.abs(e.lat)>90){this.error=this.$t("maps.field.geolocation.lat.error");return}if(!e.lng||isNaN(e.lng)||Math.abs(e.lng)>180){this.error=this.$t("maps.field.geolocation.lng.error");return}this.error=null}}};var y=function(){var t=this,e=t._self._c;return e("k-field",t._b({staticClass:"k-geolocation-field",attrs:{label:t.label,required:t.required,disabled:t.disabled},scopedSlots:t._u([{key:"options",fn:function(){return[e("k-button",{attrs:{text:t.$t("search"),icon:"search"},on:{click:function(a){return t.openSearch()}}})]},proxy:!0}])},"k-field",t.$props,!1),[e("k-input",{attrs:{type:"text",theme:"field",value:t.location.name,before:t.$t("maps.field.geolocation.name")},on:{input:function(a){return t.setValue(a,"name")}}}),e("k-input",{attrs:{type:"text",theme:"field",value:t.location.lat,before:t.$t("maps.field.geolocation.lat")},on:{input:function(a){return t.setValue(a,"lat")}}}),e("k-input",{attrs:{type:"text",theme:"field",value:t.location.lng,before:t.$t("maps.field.geolocation.lng")},on:{input:function(a){return t.setValue(a,"lng")}}}),t.error?e("k-box",{attrs:{text:t.error,theme:"negative"}}):t._e()],1)},x=[],C=l(w,y,x);const M=C.exports,E={extends:"k-dialog",props:{token:{type:String,required:!0}},data(){return{geoData:[],query:"",error:null,searchError:"search.min"}},methods:{async searchLocation(n){if(!this.token){this.searchError="maps.error.token";return}if(n.length===0){this.searchError="maps.search.empty";return}try{const e=await(await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${n}.json?types=address,country,postcode,place,locality&limit=5&access_token=${this.token}`)).json();if(this.searchError="maps.field.geolocation.error.empty",e.features){const a=e.features.slice(0,8);a?this.geoData=a.map(({place_name:o,place_type:r,center:s})=>({text:o,name:o,info:this.$t(`maps.field.geolocation.${r[0]}`),lat:s[1],lng:s[0]})):this.searchError="maps.search.error"}else this.searchError=e==null?void 0:e.message}catch{this.searchError="maps.search.error"}this.query=n},selectDropdown(n){delete n.type,delete n.text,this.$emit("input",n)}}};var L=function(){var t=this,e=t._self._c;return e("k-dialog",t._b({staticClass:"k-dialog",attrs:{"submit-button":!1,size:"medium"},on:{cancel:function(a){return t.$emit("cancel")},submit:function(a){return t.send()}}},"k-dialog",t.$props,!1),[e("k-text-field",{staticClass:"k-geolocation-search",attrs:{type:"text",theme:"field",label:t.$t("map.blocks.marker.location.name"),icon:"search",value:t.query},on:{input:function(a){return t.searchLocation(a)}}}),e("k-collection",{attrs:{items:t.geoData,empty:{icon:"alert",text:t.$t(t.searchError,1)}},on:{item:function(a){return t.selectDropdown(a)}}})],1)},S=[],V=l(E,L,S);const z=V.exports;window.panel.plugin("microman/map",{blocks:{marker:v,maps:g},fields:{geolocation:M},components:{geolocationSearchDialog:z},icons:{cup:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16 13V5H6V13C6 14.1046 6.89543 15 8 15H14C15.1046 15 16 14.1046 16 13ZM5 3H20C21.1046 3 22 3.89543 22 5V8C22 9.10457 21.1046 10 20 10H18V13C18 15.2091 16.2091 17 14 17H8C5.79086 17 4 15.2091 4 13V4C4 3.44772 4.44772 3 5 3ZM18 5V8H20V5H18ZM2 19H20V21H2V19Z"></path></svg>'}})})();
