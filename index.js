(function(){"use strict";function l(n,t,e,r,i,a,s,c){var o=typeof n=="function"?n.options:n;return t&&(o.render=t,o.staticRenderFns=e,o._compiled=!0),{exports:n,options:o}}const d={data(){return{map:null,attachedMarker:[],attachedPopup:[],token:null,fail:"",lock:!0,newCenter:!1,wait:!1}},computed:{mapId(){return`map-${this._uid}`},center(){if(!this.content.center||this.content.center.length<1)return[0,20];const n=this.field("marker").fieldsets.marker.tabs.content.fields.coordinates,{name:t,lat:e,lng:r}=this.content.center;return n.defaultName=t,n.defaultLat=e,n.defaultLng=r,[r,e]},marker(){return this.content.marker.map(({content:n})=>{var e,r,i,a,s,c,o,p,h;const t=((i=(r=(e=n.image)==null?void 0:e[0])==null?void 0:r.info)==null?void 0:i.split(" Ã— "))??[0,0];return{image:(s=(a=n.image)==null?void 0:a[0])==null?void 0:s.url,width:t[0]/100*n.size,height:t[1]/100*n.size,lat:((c=n.coordinates)==null?void 0:c.lat)??((o=n.coors)==null?void 0:o.lat)??0,lng:((p=n.coordinates)==null?void 0:p.lng)??((h=n.coors)==null?void 0:h.lng)??51,anchor:n.anchor,hasPopup:n.haspopup,popup:n.popup,popupOffset:n.popupoffset}})}},watch:{"content.style":function(n){this.map&&this.map.setStyle(`mapbox://styles/mapbox/${n}`)},"content.zoom":function(n){this.map&&this.map.setZoom(n)},center(n){this.map&&this.map.setCenter(n)},marker(n){this.attachedPopup.forEach(t=>t.remove()),this.attachedPopup=[],this.attachedMarker.forEach(t=>t.remove()),this.attachedMarker=[],this.setMarker(n)}},created(){const n="https://api.mapbox.com/mapbox-gl-js/v3.9.4";let t;const e="mapbox-gl.css";document.getElementById(e)||(t=document.createElement("link"),t.id=e,t.href=`${n}/${e}`,t.rel="stylesheet",document.head.appendChild(t));const r="mapbox-gl.js";document.getElementById(r)?this.initMap():(t=document.createElement("script"),t.id=r,t.addEventListener("load",this.initMap),t.src=`${n}/${r}`,document.body.appendChild(t))},methods:{async initMap(){const n=this;if(this.token??(this.token=(await this.$api.get("map/options")).token),this.token===null)return this.fail=n.setError("Token missing (Check: https://github.com/plain-solutions-gmbh/kirby-map?tab=readme-ov-file#configuration)");mapboxgl.accessToken=this.token,this.map=new mapboxgl.Map({container:this.mapId,center:this.center,style:"mapbox://styles/mapbox/"+this.content.style,zoom:this.content.zoom??1}),this.map.on("error",function(t){if(t.error==="ee"){n.setError("Fail to fetch mapbox. Check your api token.");return}fetch(t.error.url).then(e=>e.json()).then(e=>{n.setError(e.message)}).catch(e=>{n.setError(e)})}),this.toggleLock(this.content.center.length===0),this.map.on("dragend",()=>{this.newCenter=!0}),this.map.on("zoom",()=>{this.newCenter=!0}),this.setMarker(this.marker)},async setMarker(n){if(n)for(const[t,e]of n.entries()){let r=null;e.image&&(r=document.createElement("div"),r.className="marker",r.style.backgroundImage=`url(${e.image})`,r.style.width=`${e.width}px`,r.style.height=`${e.height}px`,r.style.backgroundSize="100%");const i=new mapboxgl.Marker({anchor:e.anchor??null,element:r,draggable:!0}).setLngLat([e.lng,e.lat]).addTo(this.map);if(i.getElement().addEventListener("click",()=>{const a=this;this.$panel.drawer.open({component:"k-form-drawer",props:this.$helper.object.merge(this.field("marker").fieldsets.marker,{value:this.content.marker[t].content}),on:{input(s){a.content.marker[t].content=s,a.$emit("update",this.content)}}})}),i.on("dragend",()=>{const a=i.getLngLat().wrap();this.content.marker[t].content.coordinates.lat=a.lat,this.content.marker[t].content.coordinates.lng=a.lng,this.$emit("update",this.content)}),this.attachedMarker.push(i),e.hasPopup){const a=new mapboxgl.Popup({offset:parseInt(e.popupOffset),focusAfterOpen:!1});a.setLngLat([e.lng,e.lat]),a.setHTML(e.popup).addTo(this.map),this.attachedPopup.push(a)}}},setError(n){this.fail=this.$t("maps.error"),console.error("Kirby-Map: "+n)},setNewCenter(){this.content.center=this.map.getCenter().wrap(),this.content.zoom=this.map.getZoom(),this.$emit("update",this.content),this.newCenter=!1},toggleLock(n=null){n??(n=this.lock),(this.lock=!n)?this.map.scrollZoom.disable():this.map.scrollZoom.enable()},async addMarker(){this.wait=!0;const n=await this.$api.get(this.field("marker").endpoints.field+"/fieldsets/marker");this.wait=!1,n.content.coordinates=this.map.getCenter().wrap(),this.content.marker.push(n),this.setMarker(),this.$emit("update",this.content)}}};var m=function(){var t=this,e=t._self._c;return e("div",[e("k-box",{staticClass:"maps-bar",attrs:{theme:"text"}},[e("k-button-group",{attrs:{layout:"collapsed"}},[t.fail.length>0?e("k-button",{staticClass:"maps-token-fail",attrs:{variant:"filled",icon:"alert",link:"https://github.com/plain-solutions-gmbh/kirby-map",theme:"negative"}},[t._v(t._s(t.fail))]):t._e(),t.lock?t._e():e("k-button",{attrs:{disabled:!t.newCenter,variant:"filled",icon:"circle-nested"},on:{click:function(r){return t.setNewCenter()}}},[t._v(t._s(t.$t("maps.blocks.button.center")))]),t.lock?t._e():e("k-button",{attrs:{variant:"filled",icon:t.wait?"loader":"pin",disabled:t.wait},on:{click:function(r){return t.addMarker()}}},[t._v(t._s(t.$t("maps.blocks.button.pin")))]),e("k-button",{attrs:{variant:"filled",theme:t.lock?"warning":"green",icon:t.lock?"lock":"unlock"},on:{click:function(r){return t.toggleLock()}}})],1)],1),e("div",{staticClass:"embedded-maps"},[e("div",{staticClass:"embedded-map-item",attrs:{id:t.mapId},on:{update:t.update}})]),e("k-plain-license",{attrs:{prefix:"map"}})],1)},u=[],f=l(d,m,u);const g=f.exports,k={computed:{url(){var n,t,e;return(e=(t=(n=this.content.image)==null?void 0:n[0])==null?void 0:t.icon)==null?void 0:e.url},description(){var n,t;return((n=this.content.coordinates)==null?void 0:n.name)??((t=this.content.coors)==null?void 0:t.name)},coordinates(){return this.content.coordinates?`${this.content.coordinates.lat},${this.content.coordinates.lng}`:this.content.coors?"(This marker was created with an older version. Please set the position from scratch.)":null}}};var _=function(){var t=this,e=t._self._c;return e("div",{staticClass:"marker-item",on:{click:t.open}},[t.url?e("div",{staticClass:"marker-item-image"},[e("img",{attrs:{src:t.url}})]):t._e(),e("div",{staticClass:"marker-item-description"},[e("p",[t._v(t._s(t.description||t.$t("empty")))]),e("p",[t._v(t._s(t.coordinates))])])])},b=[],$=l(k,_,b);const v=$.exports,y={props:{token:{type:String,required:!0},label:{type:String,required:!0},value:{type:Object,default(){return{name:void 0,lat:void 0,lng:void 0}}},required:Boolean,disabled:Boolean,default:{type:Object,default(){return{name:"",lat:0,lng:0}}}},data(){return{error:null,searchError:"search.min"}},computed:{mapId(){return`map-${this._uid}`},location(){var n,t,e,r,i,a;return{name:((n=this.value)==null?void 0:n.name)??((t=this.default)==null?void 0:t.name)??"",lat:((e=this.value)==null?void 0:e.lat)??((r=this.default)==null?void 0:r.lat)??0,lng:((i=this.value)==null?void 0:i.lng)??((a=this.default)==null?void 0:a.lng)??0}}},methods:{openSearch(){this.searchError="maps.search.empty";const n=this;this.$panel.dialog.open({component:"geolocationSearchDialog",props:{token:this.token},on:{input(t){n.$emit("input",t),n.$panel.dialog.close()}}})},setValue(n,t){let e={name:t==="name"?n:this.location.name,lat:t==="lat"?n:this.location.lat,lng:t==="lng"?n:this.location.lng};if(this.$emit("input",e),this.required&&(!e.name||!e.lat||!e.lng)){this.error=this.$t("maps.field.geolocation.error");return}if(!e.name){this.error=this.$t("maps.field.geolocation.name.error");return}if(!e.lat||isNaN(e.lat)||Math.abs(e.lat)>90){this.error=this.$t("maps.field.geolocation.lat.error");return}if(!e.lng||isNaN(e.lng)||Math.abs(e.lng)>180){this.error=this.$t("maps.field.geolocation.lng.error");return}this.error=null}}};var w=function(){var t=this,e=t._self._c;return e("k-field",t._b({staticClass:"k-geolocation-field",attrs:{label:t.label,required:t.required,disabled:t.disabled},scopedSlots:t._u([{key:"options",fn:function(){return[e("k-button",{attrs:{text:t.$t("search"),icon:"search"},on:{click:function(r){return t.openSearch()}}})]},proxy:!0}])},"k-field",t.$props,!1),[e("k-input",{attrs:{type:"text",theme:"field",value:t.location.name,before:t.$t("maps.field.geolocation.name")},on:{input:function(r){return t.setValue(r,"name")}}}),e("k-input",{attrs:{type:"text",theme:"field",value:t.location.lat,before:t.$t("maps.field.geolocation.lat")},on:{input:function(r){return t.setValue(r,"lat")}}}),e("k-input",{attrs:{type:"text",theme:"field",value:t.location.lng,before:t.$t("maps.field.geolocation.lng")},on:{input:function(r){return t.setValue(r,"lng")}}}),t.error?e("k-box",{attrs:{text:t.error,theme:"negative"}}):t._e()],1)},x=[],C=l(y,w,x);const M=C.exports,E={extends:"k-dialog",props:{token:{type:String,required:!0}},data(){return{geoData:[],query:"",error:null,searchError:"search.min"}},methods:{async searchLocation(n){if(!this.token){this.searchError="maps.error.token";return}if(n.length===0){this.searchError="maps.search.empty";return}try{const e=await(await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${n}.json?types=address,country,postcode,place,locality&limit=5&access_token=${this.token}`)).json();if(this.searchError="maps.field.geolocation.error.empty",e.features){const r=e.features.slice(0,8);r?this.geoData=r.map(({place_name:i,place_type:a,center:s})=>({text:i,name:i,info:this.$t(`maps.field.geolocation.${a[0]}`),lat:s[1],lng:s[0]})):this.searchError="maps.search.error"}else this.searchError=e==null?void 0:e.message}catch{this.searchError="maps.search.error"}this.query=n},selectDropdown(n){delete n.type,delete n.text,this.$emit("input",n)}}};var S=function(){var t=this,e=t._self._c;return e("k-dialog",t._b({staticClass:"k-dialog",attrs:{"submit-button":!1,size:"medium"},on:{cancel:function(r){return t.$emit("cancel")},submit:function(r){return t.send()}}},"k-dialog",t.$props,!1),[e("k-text-field",{staticClass:"k-geolocation-search",attrs:{type:"text",theme:"field",label:t.$t("map.blocks.marker.location.name"),icon:"search",value:t.query},on:{input:function(r){return t.searchLocation(r)}}}),e("k-collection",{attrs:{items:t.geoData,empty:{icon:"alert",text:t.$t(t.searchError,1)}},on:{item:function(r){return t.selectDropdown(r)}}})],1)},L=[],z=l(E,S,L);const j=z.exports,I={props:{prefix:{type:String,default(){return null}},styling:{type:Object,default(){return{}}}},data(){return{license:null}},computed:{licenseText(){return this.license?`<strong>${this.license.title}</strong><br />${this.$t(this.license.cta)}`:""},containerStyle(){return this.styling&&this.styling.container?this.styling.container:this.styling},textStyle(){var n;return((n=this.styling)==null?void 0:n.text)??{}},iconStyle(){var n;return((n=this.styling)==null?void 0:n.icon)??{}}},created(){this.license=window.panel.translation.data&&window.panel.translation.data["plain.licenses."+this.prefix]?window.panel.translation.data["plain.licenses."+this.prefix]:null,window.panel.translation.data["plain.licenses."+this.prefix]=null},methods:{showDialog(){this.license&&this.license.dialog&&this.$dialog(this.license.dialog)}}};var P=function(){var t=this,e=t._self._c;return t.license!==null?e("div",{staticClass:"k-plain-license",style:t.containerStyle,on:{click:t.showDialog}},[e("k-text",{style:t.textStyle,attrs:{size:"tiny",html:t.licenseText}}),e("k-icon",{style:t.iconStyle,attrs:{type:"alert"}})],1):t._e()},D=[],N=l(I,P,D);const T=N.exports;window.panel.plugin("plain/map",{blocks:{marker:v,maps:g},fields:{geolocation:M},components:{geolocationSearchDialog:j,"k-plain-license":T}})})();
