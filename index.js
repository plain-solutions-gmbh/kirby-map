(function(){"use strict";var y=function(){var e=this,n=e.$createElement,t=e._self._c||n;return t("div",{staticClass:"embedded-maps"},[t("div",{staticClass:"embedded-map-item",attrs:{id:e.mapId},on:{update:e.update}})])},$=[],R="";function f(e,n,t,r,s,a,c,d){var o=typeof e=="function"?e.options:e;n&&(o.render=n,o.staticRenderFns=t,o._compiled=!0),r&&(o.functional=!0),a&&(o._scopeId="data-v-"+a);var i;if(c?(i=function(l){l=l||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext,!l&&typeof __VUE_SSR_CONTEXT__!="undefined"&&(l=__VUE_SSR_CONTEXT__),s&&s.call(this,l),l&&l._registeredComponents&&l._registeredComponents.add(c)},o._ssrRegister=i):s&&(i=d?function(){s.call(this,(o.functional?this.parent:this).$root.$options.shadowRoot)}:s),i)if(o.functional){o._injectStyles=i;var u=o.render;o.render=function(h,m){return i.call(m),u(h,m)}}else{var p=o.beforeCreate;o.beforeCreate=p?[].concat(p,i):[i]}return{exports:e,options:o}}const b={data(){return{map:null,attachedMarker:[],attachedPopup:[],options:null}},computed:{mapId(){return`map-${this._uid}`},center(){if(!this.content.center)return[0,20];const e=this.field("marker").fieldsets.marker.tabs.content.fields.coordinates,{name:n,lat:t,lng:r}=this.content.center;return e.defaultName=n,e.defaultLat=t,e.defaultLng=r,[r,t]},marker(){return this.content.marker.map(({content:e})=>{var t,r,s,a,c,d,o,i,u,p,l,h,m,k;const n=(a=(s=(r=(t=e.image)==null?void 0:t[0])==null?void 0:r.info)==null?void 0:s.split(" \xD7 "))!=null?a:[0,0];return{image:(d=(c=e.image)==null?void 0:c[0])==null?void 0:d.url,width:n[0]/100*e.size,height:n[1]/100*e.size,lat:(p=(u=(o=e.coordinates)==null?void 0:o.lat)!=null?u:(i=e.coors)==null?void 0:i.lat)!=null?p:0,lng:(k=(m=(l=e.coordinates)==null?void 0:l.lng)!=null?m:(h=e.coors)==null?void 0:h.lng)!=null?k:51,anchor:e.anchor,hasPopup:e.haspopup,popup:e.popup,popupOffset:e.popupoffset}})}},watch:{"content.style":function(e){this.map&&this.map.setStyle(`mapbox://styles/mapbox/${e}`)},"content.zoom":function(e){this.map&&this.map.setZoom(e)},center(e){this.map&&this.map.setCenter(e)},marker(e){this.attachedPopup.forEach(n=>n.remove()),this.attachedPopup=[],this.attachedMarker.forEach(n=>n.remove()),this.attachedMarker=[],this.setMarker(e)}},created(){const e="https://api.mapbox.com/mapbox-gl-js/v2.3.1";let n;const t="mapbox-gl.css";document.getElementById(t)||(n=document.createElement("link"),n.id=t,n.href=`${e}/${t}`,n.rel="stylesheet",document.head.appendChild(n));const r="mapbox-gl.js";document.getElementById(r)?this.initMap():(n=document.createElement("script"),n.id=r,n.addEventListener("load",this.initMap),n.src=`${e}/${r}`,document.body.appendChild(n))},methods:{async initMap(){var n,t;const e=await this.$api.get("map/options");this.options=e,mapboxgl.accessToken=this.options.token,this.map=new mapboxgl.Map({container:this.mapId,center:this.center,style:`mapbox://styles/mapbox/${(n=this.content.style)!=null?n:this.options.defaultStyle}`,zoom:(t=this.content.zoom)!=null?t:1}),this.map.scrollZoom.disable(),this.setMarker(this.marker)},async setMarker(e){var n;if(!!e)for(const t of e){let r=null;t.image&&(r=document.createElement("div"),r.className="marker",r.style.backgroundImage=`url(${t.image})`,r.style.width=`${t.width}px`,r.style.height=`${t.height}px`,r.style.backgroundSize="100%");const s=new mapboxgl.Marker({anchor:(n=t.anchor)!=null?n:null,element:r}).setLngLat([t.lng,t.lat]).addTo(this.map);if(this.attachedMarker.push(s),t.hasPopup){const a=new mapboxgl.Popup({offset:parseInt(t.popupOffset),focusAfterOpen:!1});a.setLngLat([t.lng,t.lat]),a.setHTML(t.popup).addTo(this.map),this.attachedPopup.push(a)}}}}},_={};var w=f(b,y,$,!1,M,null,null,null);function M(e){for(let n in _)this[n]=_[n]}var x=function(){return w.exports}(),C=function(){var e=this,n=e.$createElement,t=e._self._c||n;return t("div",{staticClass:"marker-item",on:{click:e.open}},[e.url?t("div",{staticClass:"marker-item-image"},[t("img",{attrs:{src:e.url}})]):e._e(),t("div",{staticClass:"marker-item-description"},[t("p",[e._v(e._s(e.description||e.$t("empty")))]),t("p",[e._v(e._s(e.coordinates))])])])},S=[],q="";const L={computed:{url(){var e,n,t;return(t=(n=(e=this.content.image)==null?void 0:e[0])==null?void 0:n.icon)==null?void 0:t.url},description(){var e,n,t;return(t=(e=this.content.coordinates)==null?void 0:e.name)!=null?t:(n=this.content.coors)==null?void 0:n.name},coordinates(){return this.content.coordinates?`${this.content.coordinates.lat},${this.content.coordinates.lng}`:this.content.coors?"(This marker was created with an older version. Please set the position from scratch.)":null}}},g={};var E=f(L,C,S,!1,O,null,null,null);function O(e){for(let n in g)this[n]=g[n]}var z=function(){return E.exports}(),P=function(){var e=this,n=e.$createElement,t=e._self._c||n;return t("k-field",{staticClass:"k-geolocation-field",attrs:{label:e.label,required:e.required,disabled:e.disabled}},[t("k-text-field",{ref:"name",staticClass:"k-geolocation-search",attrs:{type:"text",theme:"field",value:e.search,icon:"search"},on:{input:e.searchLocation}}),t("k-dropdown",[t("k-dropdown-content",{ref:"dropdown"},e._l(e.dropdownOptions,function(r,s){return t("k-dropdown-item",{key:s,on:{click:function(a){return e.selectDropdown(r)}},nativeOn:{keydown:[function(a){return!a.type.indexOf("key")&&e._k(a.keyCode,"enter",13,a.key,"Enter")?null:(a.preventDefault(),e.selectDropdown(r))},function(a){return!a.type.indexOf("key")&&e._k(a.keyCode,"space",32,a.key,[" ","Spacebar"])?null:(a.preventDefault(),e.selectDropdown(r))}]}},[t("span",{domProps:{innerHTML:e._s(e.$t("maps.field.geolocation."+r.type)+": "+r.name)}})])}),1)],1),t("k-input",{ref:"name",attrs:{type:"text",theme:"field",value:e.location.name,before:e.$t("maps.field.geolocation.name")},on:{input:function(r){return e.setValue(r,"name")}}}),t("k-input",{ref:"lat",attrs:{type:"text",theme:"field",value:e.location.lat,before:e.$t("maps.field.geolocation.lat")},on:{input:function(r){return e.setValue(r,"lat")}}}),t("k-input",{ref:"lng",attrs:{type:"text",theme:"field",value:e.location.lng,before:e.$t("maps.field.geolocation.lng")},on:{input:function(r){return e.setValue(r,"lng")}}}),e.error?t("k-box",{attrs:{text:e.error,theme:"negative"}}):e._e()],1)},T=[],V="";const N={props:{token:{type:String,required:!0},label:{type:String,required:!0},value:{type:Object,default(){return{name:void 0,lat:void 0,lng:void 0}}},required:Boolean,disabled:Boolean,default:{type:Object,default(){return{name:"",lat:0,lng:0}}}},data(){return{geoData:[],error:null}},computed:{mapId(){return`map-${this._uid}`},location(){var e,n,t,r,s,a,c,d,o,i,u,p;return{name:(r=(t=(e=this.value)==null?void 0:e.name)!=null?t:(n=this.default)==null?void 0:n.name)!=null?r:"",lat:(d=(c=(s=this.value)==null?void 0:s.lat)!=null?c:(a=this.default)==null?void 0:a.lat)!=null?d:0,lng:(p=(u=(o=this.value)==null?void 0:o.lng)!=null?u:(i=this.default)==null?void 0:i.lng)!=null?p:0}},dropdownOptions(){return this.geoData.map(({place_name:e,place_type:n,center:t})=>({name:e,type:n[0],lat:t[1],lng:t[0]}))}},methods:{async searchLocation(e){if(!e){this.$refs.dropdown.close();return}try{const t=await(await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${e}.json?types=address,country,postcode,place,locality&limit=5&access_token=${this.token}`)).json();if(this.error=null,t.features){const r=t.features.slice(0,6);r?(this.geoData=r,this.$refs.dropdown.open()):(this.error=this.$t("maps.field.L.error.empty"),this.$refs.dropdown.close())}else this.error=t.message,this.$refs.dropdown.close()}catch{this.$refs.dropdown.close()}},selectDropdown(e){delete e.type,this.$refs.dropdown.close(),this.$emit("input",e)},setValue(e,n){let t={name:n==="name"?e:this.location.name,lat:n==="lat"?e:this.location.lat,lng:n==="lng"?e:this.location.lng};if(this.$emit("input",t),this.required&&(!t.name||!t.lat||!t.lng)){this.error=this.$t("maps.field.geolocation.error");return}if(!t.name){this.error=this.$t("maps.field.geolocation.name.error");return}if(!t.lat||isNaN(t.lat)||Math.abs(t.lat)>90){this.error=this.$t("maps.field.geolocation.lat.error");return}if(!t.lng||isNaN(t.lng)||Math.abs(t.lng)>180){this.error=this.$t("maps.field.geolocation.lng.error");return}this.error=null}}},v={};var j=f(N,P,T,!1,D,null,null,null);function D(e){for(let n in v)this[n]=v[n]}var I=function(){return j.exports}();window.panel.plugin("microman/map",{icons:{marker:'<path d="M7.3,15.6C2.8,9.1,2,8.4,2,6.1c0-3.3,2.7-5.9,5.9-5.9s5.9,2.7,5.9,5.9c0,2.4-0.8,3.1-5.3,9.6C8.3,16.1,7.6,16.1,7.3,15.6L7.3,15.6z M7.9,8.5c1.4,0,2.5-1.1,2.5-2.5S9.3,3.6,7.9,3.6S5.5,4.7,5.5,6.1S6.6,8.5,7.9,8.5z"/>'},blocks:{marker:z,maps:x},fields:{geolocation:I}})})();
